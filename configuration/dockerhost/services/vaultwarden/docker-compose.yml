services:
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    env_file: .env.injected
    environment:
      - DOMAIN=https://vaultwarden.home
      - SIGNUPS_ALLOWED=false
      - WEBSOCKET_ENABLED=true
    volumes:
      - ./data:/data
    networks:
      - proxy
    labels:
      - "traefik.enable=true"

      # Router 1: API e Web Vault (PÚBLICO - Para Apps Mobile)
      - "traefik.http.routers.vaultwarden.rule=Host(`vaultwarden.home`)"
      - "traefik.http.routers.vaultwarden.entrypoints=websecure"
      - "traefik.http.routers.vaultwarden.tls=true"
      - "traefik.http.routers.vaultwarden.service=vaultwarden-svc"

      # Router 2: Painel Admin (PROTEGIDO - Authentik)
      - "traefik.http.routers.vaultwarden-admin.rule=Host(`vaultwarden.home`) && PathPrefix(`/admin`)"
      - "traefik.http.routers.vaultwarden-admin.entrypoints=websecure"
      - "traefik.http.routers.vaultwarden-admin.tls=true"
      - "traefik.http.routers.vaultwarden-admin.middlewares=authentik@docker"
      - "traefik.http.routers.vaultwarden-admin.service=vaultwarden-svc"

      # Definição do Serviço
      - "traefik.http.services.vaultwarden-svc.loadbalancer.server.port=80"

networks:
  proxy:
    external: true
