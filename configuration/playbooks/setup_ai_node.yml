---
- name: Provisionamento do AI Node (Hardening + Ollama + Open WebUI)
  hosts: ai_node
  become: yes
  vars:
    # Versões e Caminhos
    homelab_repo: "https://github.com/fajremvp/homelab.git"
    knowledge_base_path: "/opt/knowledge_base"
    ai_stack_path: "/opt/ai-stack"

  tasks:
    # ==============================================================================
    # 1. HARDENING BASE (Herdado do padrão Debian)
    # ==============================================================================
    - name: Atualizar cache e sistema (Safe Upgrade)
      apt:
        update_cache: yes
        upgrade: safe
        cache_valid_time: 3600

    - name: Instalar ferramentas essenciais
      apt:
        name:
          - curl
          - wget
          - gnupg
          - git
          - rsync
          - htop
          - ncdu
          - fastfetch # Tem que ter :D
          - sudo
          - vim
          - fail2ban
        state: present

    - name: Configurar Timezone para America/Sao_Paulo
      timezone:
        name: America/Sao_Paulo

    # --- SSH Hardening ---
    - name: Hardening SSH - Desativar Login Root (Permitir pro Ansible agora, bloquear depois se quiser)
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin prohibit-password'
        state: present
      notify: Restart SSH

    - name: Hardening SSH - Desativar Senha
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication no'
        state: present
      notify: Restart SSH

    # --- Docker Setup (Oficial) ---
    - name: Adicionar chave GPG do Docker
      block:
        - file:
            path: /etc/apt/keyrings
            state: directory
            mode: '0755'
        - get_url:
            url: https://download.docker.com/linux/debian/gpg
            dest: /etc/apt/keyrings/docker.asc
            mode: '0644'

    - name: Adicionar repositório Docker
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
        state: present

    - name: Instalar Docker Engine
      apt:
        name: [docker-ce, docker-ce-cli, containerd.io, docker-buildx-plugin, docker-compose-plugin]
        state: present

    - name: Configurar Log Driver json-file (Padrão LGM Stack)
      copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "3"
            }
          }
      notify: Restart Docker

    # ==============================================================================
    # 2. PREPARAÇÃO DO CÉREBRO (RAG)
    # ==============================================================================
    - name: Criar diretório da Base de Conhecimento
      file:
        path: "{{ knowledge_base_path }}"
        state: directory
        mode: '0755'

    - name: Clonar Repositório Homelab (Contexto para a IA)
      git:
        repo: "{{ homelab_repo }}"
        dest: "{{ knowledge_base_path }}/homelab"
        force: yes
        version: main
      # Colocar isso num cronjob depois para a IA estar sempre atualizada

    # ==============================================================================
    # 3. DEPLOY DA STACK (Ollama + Open WebUI)
    # ==============================================================================
    - name: Criar diretório da Stack AI
      file:
        path: "{{ ai_stack_path }}"
        state: directory
        mode: '0755'

    - name: Criar docker-compose.yml
      copy:
        dest: "{{ ai_stack_path }}/docker-compose.yml"
        content: |
          services:
            ollama:
              image: ollama/ollama:latest
              container_name: ollama
              volumes:
                - ollama_data:/root/.ollama
              restart: always 
              networks:
                - ai-net

            open-webui:
              image: ghcr.io/open-webui/open-webui:main
              container_name: open-webui
              volumes:
                - open-webui_data:/app/backend/data
                # Mapeia seu repo clonado para dentro da IA como 'somente leitura'
                - {{ knowledge_base_path }}/homelab:/data/docs/homelab:ro
              ports:
                - "3000:8080"
              environment:
                - OLLAMA_BASE_URL=http://ollama:11434
                - WEBUI_AUTH=true
                - WEBUI_NAME="Jarvis"
                # Habilita RAG
                - DOCS_DIR=/data/docs
              depends_on:
                - ollama
              restart: always
              networks:
                - ai-net

          volumes:
            ollama_data:
            open-webui_data:

          networks:
            ai-net:
              driver: bridge

    - name: Subir a Stack AI
      community.docker.docker_compose_v2:
        project_src: "{{ ai_stack_path }}"
        state: present

  handlers:
    - name: Restart SSH
      service: name=ssh state=restarted
    - name: Restart Docker
      service: name=docker state=restarted
