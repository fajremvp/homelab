---
- name: Gerenciamento Total dos Stacks Docker (Híbrido Systemd/Compose)
  hosts: dockerhost
  become: yes

  vars_prompt:
    - name: grafana_password
      prompt: "Digite a senha de Admin do Grafana"
      private: yes  # Isso esconde o que for digitado

    - name: ntfy_token
      prompt: "Digite o Token do CrowdSec (Ntfy)"
      private: yes

    - name: authentik_role_id
      prompt: "AUTHENTIK RoleID"
      private: no
    - name: authentik_secret_id
      prompt: "AUTHENTIK SecretID"
      private: yes

    - name: vaultwarden_role_id
      prompt: "VAULTWARDEN RoleID"
      private: no
    - name: vaultwarden_secret_id
      prompt: "VAULTWARDEN SecretID"
      private: yes

  vars:
    base_dir: "/opt/services"
    auth_dir: "/opt/auth"
    mon_dir: "/opt/monitoring"

  tasks:
    # --- 1. PREPARAÇÃO ---
    - name: Garantir dependências python do Docker
      apt:
        name: python3-docker
        state: present

    # --- 2. ESTRUTURA DE DIRETÓRIOS ---
    - name: Criar diretórios base
      file:
        path: "{{ item }}"
        state: directory
        owner: fajre
        group: docker
        mode: '0755'
      loop:
        - "{{ base_dir }}/traefik"
        - "{{ base_dir }}/vaultwarden"
        - "{{ base_dir }}/whoami"
        - "{{ auth_dir }}/authentik"

    # --- 3. SINCRONIZAÇÃO (GIT -> SERVER) ---
    - name: Deploy Configs (Traefik, Vaultwarden, Whoami)
      copy:
        src: "../dockerhost/{{ item.src }}/"
        dest: "{{ base_dir }}/{{ item.dest }}/"
        owner: fajre
        group: docker
        mode: '0644'
      loop:
        - { src: 'traefik', dest: 'traefik' }
        - { src: 'vaultwarden', dest: 'vaultwarden' }
        - { src: 'whoami', dest: 'whoami' }

    - name: Deploy Configs (Authentik)
      copy:
        src: "../dockerhost/authentik/"
        dest: "{{ auth_dir }}/authentik/"
        owner: fajre
        group: docker
        mode: '0644'

    # --- 4. PERMISSÕES E SCRIPTS ---
    - name: Tornar scripts start-with-vault executáveis
      shell: "find {{ base_dir }} {{ auth_dir }} -name '*.sh' -exec chmod +x {} \\;"
      changed_when: false

    # --- CONFIGURAR SEGREDOS NO DISCO (/etc/vault) ---
    - name: Criar diretório de segredos Vault
      file:
        path: "/etc/vault"
        state: directory
        owner: root
        group: root
        mode: '0700'

    # AUTHENTIK
    - name: Gravar Authentik RoleID
      copy:
        content: "{{ authentik_role_id }}"
        dest: "/etc/vault/authentik.roleid"
        owner: root
        group: root
        mode: '0600'
    - name: Gravar Authentik SecretID
      copy:
        content: "{{ authentik_secret_id }}"
        dest: "/etc/vault/authentik.secretid"
        owner: root
        group: root
        mode: '0600'

    # VAULTWARDEN
    - name: Gravar Vaultwarden RoleID
      copy:
        content: "{{ vaultwarden_role_id }}"
        dest: "/etc/vault/vaultwarden.roleid"
        owner: root
        group: root
        mode: '0600'
    - name: Gravar Vaultwarden SecretID
      copy:
        content: "{{ vaultwarden_secret_id }}"
        dest: "/etc/vault/vaultwarden.secretid"
        owner: root
        group: root
        mode: '0600'

    # --- 5. INSTALAÇÃO DOS SERVIÇOS SYSTEMD (Para Apps com Vault) ---
    
    # Authentik Service
    - name: Instalar Authentik Systemd Service
      copy:
        src: "../dockerhost/authentik/authentik-vault.service"
        dest: "/etc/systemd/system/authentik-vault.service"
        mode: '0644'
      notify: Reload Systemd

    # Vaultwarden Service
    - name: Instalar Vaultwarden Systemd Service
      copy:
        src: "../dockerhost/vaultwarden/vaultwarden-vault.service"
        dest: "/etc/systemd/system/vaultwarden-vault.service"
        mode: '0644'
      notify: Reload Systemd

    # --- 6. ATIVAÇÃO DOS SERVIÇOS ---

    # Grupo A: Docker Compose Puro (Sem segredos do Vault)
    - name: Start/Update Traefik (Direto)
      community.docker.docker_compose_v2:
        project_src: "{{ base_dir }}/traefik"
        state: present

    - name: Start/Update Whoami (Direto)
      community.docker.docker_compose_v2:
        project_src: "{{ base_dir }}/whoami"
        state: present

    # Grupo B: Via Systemd (Com injeção de segredos)
    # Sem docker_compose aqui. O Systemd chama o script que chama o docker.
    - name: Habilitar e Iniciar Authentik com Vault
      service:
        name: authentik-vault
        state: started
        enabled: yes

    - name: Habilitar e Iniciar Vaultwarden com Vault
      service:
        name: vaultwarden-vault
        state: started
        enabled: yes 
    
    # --- SECURITY STACK (CROWDSEC) ---
    - name: Criar diretório de Security
      file:
        path: "/opt/security"
        state: directory
        owner: fajre
        group: docker
        mode: '0750'

    - name: Sincronizar configs de Security
      synchronize:
        src: "../dockerhost/security/"
        dest: "/opt/security/"
        # Apaga arquivos no servidor que não existem no Git (Limpeza)
        delete: yes 
        recursive: yes
        rsync_opts:
          - "--exclude=*.j2"
          - "--exclude=crowdsec/notifications/http.yaml"
      notify: Restart CrowdSec

    - name: Configurar Notificação CrowdSec (Com Token)
      template:
        src: "../dockerhost/security/crowdsec/notifications/http.yaml.j2"
        dest: "/opt/security/crowdsec/notifications/http.yaml"
        owner: fajre
        group: docker
        mode: '0600' # Permissão restrita (tem senha)
      notify: Restart CrowdSec

    - name: Start/Update Security Stack
      community.docker.docker_compose_v2:
        # Agora o docker-compose.yml está na raiz de /opt/security, então isso funciona:
        project_src: "/opt/security"
        state: present
      notify: Restart CrowdSec

    # --- MONITORAMENTO ---
    - name: Criar diretório de Monitoring
      file:
        path: "{{ mon_dir }}"
        state: directory
        owner: fajre
        group: docker
        mode: '0750'

    - name: Sincronizar configs de Monitoring
      synchronize:
        src: "../dockerhost/monitoring/"
        dest: "{{ mon_dir }}/"
        delete: no
        recursive: yes
        rsync_opts:
          - "--exclude=.env" 

    - name: Gerar .env do Monitoring
      copy:
        dest: "{{ mon_dir }}/.env"
        content: |
          GRAFANA_PASSWORD={{ grafana_password }}
        owner: fajre
        group: docker
        mode: '0600'
        force: no 

    - name: Start/Update Monitoring Stack
      community.docker.docker_compose_v2:
        project_src: "{{ mon_dir }}"
        state: present

  handlers:
    - name: Reload Systemd
      systemd:
        daemon_reload: yes

    - name: Restart CrowdSec
      community.docker.docker_container:
        name: crowdsec
        restart: yes
