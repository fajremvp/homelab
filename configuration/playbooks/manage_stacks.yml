---
- name: Gerenciamento Total dos Stacks Docker (Híbrido Systemd/Compose)
  hosts: dockerhost
  become: yes

  vars_prompt:
    - name: grafana_password
      prompt: "Digite a senha de Admin do Grafana"
      private: yes  # Isso esconde o que for digitado

  vars:
    base_dir: "/opt/services"
    auth_dir: "/opt/auth"
    mon_dir: "opt/monitoring"

  tasks:
    # --- 1. PREPARAÇÃO ---
    - name: Garantir dependências python do Docker
      apt:
        name: python3-docker
        state: present

    # --- 2. ESTRUTURA DE DIRETÓRIOS ---
    - name: Criar diretórios base
      file:
        path: "{{ item }}"
        state: directory
        owner: fajre
        group: docker
        mode: '0755'
      loop:
        - "{{ base_dir }}/traefik"
        - "{{ base_dir }}/vaultwarden"
        - "{{ base_dir }}/whoami"
        - "{{ auth_dir }}/authentik"

    # --- 3. SINCRONIZAÇÃO (GIT -> SERVER) ---
    - name: Deploy Configs (Traefik, Vaultwarden, Whoami)
      copy:
        src: "../dockerhost/{{ item.src }}/"
        dest: "{{ base_dir }}/{{ item.dest }}/"
        owner: fajre
        group: docker
        mode: '0644'
      loop:
        - { src: 'traefik', dest: 'traefik' }
        - { src: 'vaultwarden', dest: 'vaultwarden' }
        - { src: 'whoami', dest: 'whoami' }

    - name: Deploy Configs (Authentik)
      copy:
        src: "../dockerhost/authentik/"
        dest: "{{ auth_dir }}/authentik/"
        owner: fajre
        group: docker
        mode: '0644'

    # --- 4. PERMISSÕES E SCRIPTS ---
    - name: Tornar scripts start-with-vault executáveis
      shell: "find {{ base_dir }} {{ auth_dir }} -name '*.sh' -exec chmod +x {} \\;"
      changed_when: false

    # --- 5. INSTALAÇÃO DOS SERVIÇOS SYSTEMD (Para Apps com Vault) ---
    
    # Authentik Service
    - name: Instalar Authentik Systemd Service
      copy:
        src: "../dockerhost/authentik/authentik-vault.service"
        dest: "/etc/systemd/system/authentik-vault.service"
        mode: '0644'
      notify: Reload Systemd

    # Vaultwarden Service
    - name: Instalar Vaultwarden Systemd Service
      copy:
        src: "../dockerhost/vaultwarden/vaultwarden-vault.service"
        dest: "/etc/systemd/system/vaultwarden-vault.service"
        mode: '0644'
      notify: Reload Systemd

    # --- 6. ATIVAÇÃO DOS SERVIÇOS ---

    # Grupo A: Docker Compose Puro (Sem segredos do Vault)
    - name: Start/Update Traefik (Direto)
      community.docker.docker_compose_v2:
        project_src: "{{ base_dir }}/traefik"
        state: present

    - name: Start/Update Whoami (Direto)
      community.docker.docker_compose_v2:
        project_src: "{{ base_dir }}/whoami"
        state: present

    # Grupo B: Via Systemd (Com injeção de segredos)
    # Sem docker_compose aqui. O Systemd chama o script que chama o docker.
    - name: Habilitar e Iniciar Authentik com Vault
      service:
        name: authentik-vault
        state: started
        enabled: yes

    - name: Habilitar e Iniciar Vaultwarden com Vault
      service:
        name: vaultwarden-vault
        state: started
        enabled: yes
    
    # --- SEGURANÇA (CROWDSEC) ---
    - name: Criar diretório de Security
      file:
        path: "/opt/security"
        state: directory
        owner: fajre
        group: docker
        mode: '0750'

    - name: Sincronizar configs de Security
      synchronize:
        src: "../dockerhost/security/"
        dest: "/opt/security/"
        delete: no
        recursive: yes

    - name: Start/Update Security Stack
      community.docker.docker_compose_v2:
        project_src: "/opt/security"
        state: present

    # --- AUTOMAÇÃO PÓS-BOOT (FIX CROWDSEC) ---
    - name: Aguardar CrowdSec iniciar
      pause:
        seconds: 15

    - name: Forçar atualização do Hub CrowdSec
      command: docker exec crowdsec cscli hub update
      register: hub_update
      changed_when: "'Updated' in hub_update.stdout"
      ignore_errors: yes

    - name: Instalar Coleção Authentik (Pós-Boot)
      command: docker exec crowdsec cscli collections install crowdsecurity/authentik
      register: install_auth
      changed_when: "'Enabled' in install_auth.stdout"
      failed_when: 
        - install_auth.rc != 0
        - "'Nothing to install' not in install_auth.stdout"

    # --- MONITORAMENTO ---
    - name: Criar diretório de Monitoring
      file:
        path: "{{ mon_dir }}"
        state: directory
        owner: fajre
        group: docker
        mode: '0750'

    - name: Sincronizar configs de Monitoring
      synchronize:
        src: "../dockerhost/monitoring/"
        dest: "{{ mon_dir }}/"
        delete: no
        recursive: yes
        rsync_opts:
          - "--exclude=.env" 

    - name: Gerar .env do Monitoring
      copy:
        dest: "{{ mon_dir }}/.env"
        content: |
          GRAFANA_PASSWORD={{ grafana_password }}
        owner: fajre
        group: docker
        mode: '0600'
        force: no 

    - name: Start/Update Monitoring Stack
      community.docker.docker_compose_v2:
        project_src: "{{ mon_dir }}"
        state: present

  handlers:
    - name: Reload Systemd
      systemd:
        daemon_reload: yes
