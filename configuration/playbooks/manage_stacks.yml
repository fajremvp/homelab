---
- name: Gerenciamento Total dos Stacks Docker (Híbrido Systemd/Compose)
  hosts: dockerhost
  become: yes

  vars_prompt:
    - name: grafana_password
      prompt: "Digite a senha de Admin do Grafana"
      private: yes  # Isso esconde o que for digitado

    - name: ntfy_token
      prompt: "Digite o Token do CrowdSec (Ntfy)"
      private: yes

    - name: authentik_role_id
      prompt: "AUTHENTIK RoleID"
      private: no
    - name: authentik_secret_id
      prompt: "AUTHENTIK SecretID"
      private: yes

    - name: vaultwarden_role_id
      prompt: "VAULTWARDEN RoleID"
      private: no
    - name: vaultwarden_secret_id
      prompt: "VAULTWARDEN SecretID"
      private: yes

    - name: pve_password
      prompt: "Digite a SENHA do usuário monitoring@pve"
      private: yes

    - name: tailscale_authkey
      prompt: "Cole a Tailscale Auth Key (tskey-auth-...)"
      private: yes

  vars:
    base_dir: "/opt/services"
    auth_dir: "/opt/auth"
    mon_dir: "/opt/monitoring"
    alertmanager_dir: "{{ mon_dir }}/alertmanager"
    pve_dir: "{{ mon_dir }}/pve"

  tasks:
    # --- 1. PREPARAÇÃO ---
    - name: Garantir dependências python do Docker
      apt:
        name: python3-docker
        state: present

    # --- 2. ESTRUTURA DE DIRETÓRIOS ---
    - name: Criar diretórios base
      file:
        path: "{{ item }}"
        state: directory
        owner: fajre
        group: docker
        mode: '0755'
      loop:
        - "{{ base_dir }}"       # /opt/services
        - "{{ auth_dir }}"       # /opt/auth
        - "{{ mon_dir }}"        # /opt/monitoring
        - "/opt/security"

    # --- 3. SINCRONIZAÇÃO (GIT -> SERVER) ---
    - name: Deploy Configs (Traefik, Vaultwarden, Whoami, Nostr, Tailscale)
      synchronize:
        src: "../dockerhost/services/{{ item }}/"
        dest: "{{ base_dir }}/{{ item }}/"
        recursive: yes
        rsync_opts:
          - "--chmod=D0755,F0644"
          - "--exclude=.env"
          - "--exclude=data/"      # Protege dados do Vaultwarden/Nostr se estiverem na pasta
          - "--exclude=tor-keys/"  # Protege chaves do Nostr
          - "--exclude=state/"     # Protege estado do Tailscale
      loop:
        - traefik
        - vaultwarden
        - whoami
        - nostr
        - tailscale

    - name: Deploy Auth Stack (Authentik)
      synchronize:
        src: "../dockerhost/auth/authentik/"
        dest: "{{ auth_dir }}/authentik/"
        recursive: yes
        rsync_opts:
          - "--exclude=.env"
          - "--exclude=media/"
          - "--exclude=custom-templates/"

    # --- 4. PERMISSÕES E SCRIPTS ---
    - name: Tornar scripts start-with-vault executáveis
      shell: "find {{ base_dir }} {{ auth_dir }} -name '*.sh' -exec chmod +x {} \\;"
      changed_when: false

    # --- CONFIGURAR SEGREDOS NO DISCO (/etc/vault) ---
    - name: Criar diretório de segredos Vault
      file:
        path: "/etc/vault"
        state: directory
        owner: root
        group: root
        mode: '0700'

    # AUTHENTIK
    - name: Gravar Authentik RoleID
      copy:
        content: "{{ authentik_role_id }}"
        dest: "/etc/vault/authentik.roleid"
        owner: root
        group: root
        mode: '0600'
    - name: Gravar Authentik SecretID
      copy:
        content: "{{ authentik_secret_id }}"
        dest: "/etc/vault/authentik.secretid"
        owner: root
        group: root
        mode: '0600'

    # VAULTWARDEN
    - name: Gravar Vaultwarden RoleID
      copy:
        content: "{{ vaultwarden_role_id }}"
        dest: "/etc/vault/vaultwarden.roleid"
        owner: root
        group: root
        mode: '0600'
    - name: Gravar Vaultwarden SecretID
      copy:
        content: "{{ vaultwarden_secret_id }}"
        dest: "/etc/vault/vaultwarden.secretid"
        owner: root
        group: root
        mode: '0600'

    # --- 5. INSTALAÇÃO DOS SERVIÇOS SYSTEMD (Para Apps com Vault) ---
    
    # Authentik Service
    - name: Instalar Authentik Systemd Service
      copy:
        src: "../dockerhost/auth/authentik/authentik-vault.service"
        dest: "/etc/systemd/system/authentik-vault.service"
        mode: '0644'
      notify: Reload Systemd

    # Vaultwarden Service
    - name: Instalar Vaultwarden Systemd Service
      copy:
        src: "../dockerhost/services/vaultwarden/vaultwarden-vault.service"
        dest: "/etc/systemd/system/vaultwarden-vault.service"
        mode: '0644'
      notify: Reload Systemd

    # Tailscale NAT Service
    - name: Instalar Tailscale NAT Service
      copy:
        src: "../dockerhost/services/tailscale/tailscale-nat.service"
        dest: "/etc/systemd/system/tailscale-nat.service"
        mode: '0644'
      notify: Reload Systemd

    # --- 6. ATIVAÇÃO DOS SERVIÇOS ---

    # Grupo A: Docker Compose Puro (Sem segredos do Vault)
    - name: Start/Update Traefik (Direto)
      community.docker.docker_compose_v2:
        project_src: "{{ base_dir }}/traefik"
        state: present

    - name: Start/Update Whoami (Direto)
      community.docker.docker_compose_v2:
        project_src: "{{ base_dir }}/whoami"
        state: present

    # Grupo B: Via Systemd (Com injeção de segredos)
    # Sem docker_compose aqui. O Systemd chama o script que chama o docker.
    - name: Habilitar e Iniciar Authentik com Vault
      service:
        name: authentik-vault
        state: started
        enabled: yes

    - name: Habilitar e Iniciar Vaultwarden com Vault
      service:
        name: vaultwarden-vault
        state: started
        enabled: yes

    - name: Habilitar e Iniciar Tailscale NAT Service
      service:
        name: tailscale-nat
        state: started
        enabled: yes
    
    # --- SECURITY STACK (CROWDSEC) ---
    - name: Criar diretório de Security
      file:
        path: "/opt/security"
        state: directory
        owner: fajre
        group: docker
        mode: '0750'

    - name: Sincronizar configs de Security
      synchronize:
        src: "../dockerhost/security/"
        dest: "/opt/security/"
        # Apaga arquivos no servidor que não existem no Git (Limpeza)
        delete: yes 
        recursive: yes
        rsync_opts:
          - "--exclude=*.j2"
          - "--exclude=crowdsec/notifications/http.yaml"
      notify: Restart CrowdSec

    - name: Configurar Notificação CrowdSec (Com Token)
      template:
        src: "../dockerhost/security/crowdsec/notifications/http.yaml.j2"
        dest: "/opt/security/crowdsec/notifications/http.yaml"
        owner: fajre
        group: docker
        mode: '0600' # Permissão restrita (tem senha)
      notify: Restart CrowdSec

    - name: Start/Update Security Stack
      community.docker.docker_compose_v2:
        # Agora o docker-compose.yml está na raiz de /opt/security, então isso funciona:
        project_src: "/opt/security"
        state: present
      notify: Restart CrowdSec

    # --- NOSTR STACK ---
    - name: Sincronizar stack Nostr
      synchronize:
        src: "../dockerhost/services/nostr/"
        dest: "/opt/services/nostr/"
        delete: yes
        recursive: yes
        rsync_opts:
          - "--chmod=D0755,F0644"
          - "--chown={{ ansible_user }}:{{ ansible_user }}"
          - "--exclude=tor-keys/**" # Protege as chaves geradas de serem apagadas

    # Tor exige permissão 700 estrita
    - name: Corrigir permissões da pasta Tor Keys
      file:
        path: "/opt/services/nostr/tor-keys"
        state: directory
        owner: "root"
        group: "root"
        mode: '0700'

    - name: Deploy Nostr Stack
      community.docker.docker_compose_v2:
        project_src: "/opt/services/nostr"
        state: present

    # --- TAILSCALE (PRIMARY VPN) ---
    - name: Sincronizar stack Tailscale
      synchronize:
        src: "../dockerhost/services/tailscale/"
        dest: "/opt/services/tailscale/"
        delete: yes
        recursive: yes
        rsync_opts:
          - "--chmod=D0755,F0644"
          - "--chown={{ ansible_user }}:{{ ansible_user }}"
          - "--exclude=state/**"
          - "--exclude=.env"

    - name: Gerar .env do Tailscale
      copy:
        dest: "/opt/services/tailscale/.env"
        content: |
          TS_AUTHKEY={{ tailscale_authkey }}
        owner: fajre
        group: docker
        mode: '0600' # (só root lê)

    - name: Deploy Tailscale Stack
      community.docker.docker_compose_v2:
        project_src: "/opt/services/tailscale"
        state: present

    # --- MONITORAMENTO ---
    - name: Criar diretórios de Monitoring
      file:
        path: "{{ item }}"
        state: directory
        owner: fajre
        group: docker
        mode: '0750'
      loop:
        - "{{ mon_dir }}"
        - "{{ alertmanager_dir }}"
        - "{{ pve_dir }}"

    # Sincroniza arquivos estáticos (Prometheus, Grafana, Loki)
    # Exclui os templates para não sobrescrever com arquivo cru
    - name: Sincronizar configs de Monitoring (Base)
      synchronize:
        src: "../dockerhost/monitoring/"
        dest: "{{ mon_dir }}/"
        delete: no
        recursive: yes
        rsync_opts:
          - "--exclude=.env"
          - "--exclude=alertmanager/config.yml"    # Ignora se tiver local
          - "--exclude=alertmanager/config.yml.j2" # Não copia o template .j2 pro servidor
          # Protege o arquivo de secrets
          - "--exclude=pve/pve.yml"
          - "--exclude=pve/pve.yml.j2"
      notify: Restart Prometheus

    # Gera a config do Alertmanager injetando o Token do prompt
    - name: Configurar Alertmanager (Com Token)
      template:
        src: "../dockerhost/monitoring/alertmanager/config.yml.j2"
        dest: "{{ alertmanager_dir }}/config.yml"
        owner: fajre
        group: docker
        mode: '0644' # Protegido (tem token)
      notify: Restart Alertmanager

    # --- NOVA TASK: Configurar PVE Exporter ---
    - name: Configurar PVE Exporter (Com Token)
      template:
        src: "../dockerhost/monitoring/pve/pve.yml.j2"
        dest: "{{ pve_dir }}/pve.yml"
        owner: fajre
        group: docker
        mode: '0644' # Leitura para o container (usuário nobody)
      notify: Restart PveExporter

    # Garante permissão da regra de alerta (o rsync já levou, mas garantimos leitura)
    - name: Ajustar permissão das regras de alerta
      file:
        path: "{{ mon_dir }}/prometheus/alert.rules.yml"
        mode: '0644'

    - name: Gerar .env do Monitoring
      copy:
        dest: "{{ mon_dir }}/.env"
        content: |
          GRAFANA_PASSWORD={{ grafana_password }}
        owner: fajre
        group: docker
        mode: '0600'
        force: no

    # --- FIX PARA ALLOY (SIEM) ---
    # Garante que o arquivo de log existe para o Docker não criar uma pasta no lugar
    - name: Garantir existência do auth.log para o Alloy
      file:
        path: "/var/log/auth.log"
        state: touch
        owner: root
        group: adm
        mode: '0640'
        modification_time: preserve
        access_time: preserve


    - name: Start/Update Monitoring Stack
      community.docker.docker_compose_v2:
        project_src: "{{ mon_dir }}"
        state: present

  handlers:
    - name: Reload Systemd
      systemd:
        daemon_reload: yes

    - name: Restart CrowdSec
      community.docker.docker_container:
        name: crowdsec
        restart: yes

    - name: Restart Prometheus
      community.docker.docker_container:
        name: prometheus
        restart: yes

    - name: Restart Alertmanager
      community.docker.docker_container:
        name: alertmanager
        restart: yes
    
    - name: Restart PveExporter
      community.docker.docker_container:
        name: pve-exporter
        restart: yes
