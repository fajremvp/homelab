---
- name: Gerenciamento Total dos Stacks Docker (Híbrido Systemd/Compose)
  hosts: dockerhost
  become: yes
  vars:
    base_dir: "/opt/services"
    auth_dir: "/opt/auth"

  tasks:
    # --- 1. PREPARAÇÃO ---
    - name: Garantir dependências python do Docker
      apt:
        name: python3-docker
        state: present

    # --- 2. ESTRUTURA DE DIRETÓRIOS ---
    - name: Criar diretórios base
      file:
        path: "{{ item }}"
        state: directory
        owner: fajre
        group: docker
        mode: '0755'
      loop:
        - "{{ base_dir }}/traefik"
        - "{{ base_dir }}/vaultwarden"
        - "{{ base_dir }}/whoami"
        - "{{ auth_dir }}/authentik"

    # --- 3. SINCRONIZAÇÃO (GIT -> SERVER) ---
    - name: Deploy Configs (Traefik, Vaultwarden, Whoami)
      copy:
        src: "../dockerhost/{{ item.src }}/"
        dest: "{{ base_dir }}/{{ item.dest }}/"
        owner: fajre
        group: docker
        mode: '0644'
      loop:
        - { src: 'traefik', dest: 'traefik' }
        - { src: 'vaultwarden', dest: 'vaultwarden' }
        - { src: 'whoami', dest: 'whoami' }

    - name: Deploy Configs (Authentik)
      copy:
        src: "../dockerhost/authentik/"
        dest: "{{ auth_dir }}/authentik/"
        owner: fajre
        group: docker
        mode: '0644'

    # --- 4. PERMISSÕES E SCRIPTS ---
    - name: Tornar scripts start-with-vault executáveis
      shell: "find {{ base_dir }} {{ auth_dir }} -name '*.sh' -exec chmod +x {} \\;"
      changed_when: false

    # --- 5. INSTALAÇÃO DOS SERVIÇOS SYSTEMD (Para Apps com Vault) ---
    
    # Authentik Service
    - name: Instalar Authentik Systemd Service
      copy:
        src: "../dockerhost/authentik/authentik-vault.service"
        dest: "/etc/systemd/system/authentik-vault.service"
        mode: '0644'
      notify: Reload Systemd

    # Vaultwarden Service
    - name: Instalar Vaultwarden Systemd Service
      copy:
        src: "../dockerhost/vaultwarden/vaultwarden-vault.service"
        dest: "/etc/systemd/system/vaultwarden-vault.service"
        mode: '0644'
      notify: Reload Systemd

    # --- 6. ATIVAÇÃO DOS SERVIÇOS ---

    # Grupo A: Docker Compose Puro (Sem segredos do Vault)
    - name: Start/Update Traefik (Direto)
      community.docker.docker_compose_v2:
        project_src: "{{ base_dir }}/traefik"
        state: present

    - name: Start/Update Whoami (Direto)
      community.docker.docker_compose_v2:
        project_src: "{{ base_dir }}/whoami"
        state: present

    # Grupo B: Via Systemd (Com injeção de segredos)
    # Não usamos docker_compose aqui. O Systemd chama o script que chama o docker.
    - name: Habilitar e Iniciar Authentik com Vault
      service:
        name: authentik-vault
        state: started
        enabled: yes

    - name: Habilitar e Iniciar Vaultwarden com Vault
      service:
        name: vaultwarden-vault
        state: started
        enabled: yes

  handlers:
    - name: Reload Systemd
      systemd:
        daemon_reload: yes
