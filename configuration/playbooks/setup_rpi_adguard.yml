---
- name: Provisionamento AdGuard Home (Amnésico)
  hosts: rpi
  become: true

  vars:
    adguard_version: "v0.107.56"
    install_dir: "/opt/AdGuardHome"
    dns_port: 53

  tasks:
    # --- PREPARAÇÃO (LIMPEZA) ---
    - name: Parar serviço AdGuard
      service:
        name: AdGuardHome
        state: stopped
      failed_when: false

    - name: Remover configuração antiga (Clean Slate)
      file:
        path: "{{ install_dir }}/AdGuardHome.yaml"
        state: absent

    # --- REDE ---
    - name: Verificar systemd-resolved
      stat:
        path: /lib/systemd/system/systemd-resolved.service
      register: resolved_service_file

    - name: Parar systemd-resolved
      service:
        name: systemd-resolved
        state: stopped
        enabled: false
      when: resolved_service_file.stat.exists

    - name: Configurar NetworkManager (dns=none)
      copy:
        dest: /etc/NetworkManager/conf.d/99-disable-dns.conf
        content: "[main]\ndns=none"
      notify: Reload NetworkManager

    - name: Garantir resolv.conf
      copy:
        dest: /etc/resolv.conf
        content: "nameserver 1.1.1.1\nnameserver 9.9.9.9\n"
        force: true

    # --- INSTALAÇÃO ---
    - name: Baixar e Extrair AdGuard
      unarchive:
        src: "https://github.com/AdguardTeam/AdGuardHome/releases/download/{{ adguard_version }}/AdGuardHome_linux_arm64.tar.gz"
        dest: "/opt/"
        remote_src: true
        creates: "{{ install_dir }}/AdGuardHome"

    - name: Permissões Estritas (0700)
      file:
        path: "{{ install_dir }}"
        state: directory
        mode: '0700'
        owner: root
        group: root

    # --- CONFIGURAÇÃO ---
    - name: Injetar AdGuardHome.yaml (Inline Syntax)
      copy:
        dest: "{{ install_dir }}/AdGuardHome.yaml"
        owner: root
        group: root
        mode: '0600'
        content: |
          schema_version: 29

          http:
            address: 0.0.0.0:3000

          auth_attempts: 5
          block_auth_min: 15
          language: pt-br
          theme: dark

          log:
            file: ""
            verbose: false

          dns:
            bind_hosts: [ "0.0.0.0" ]

            port: {{ dns_port }}
            protection_enabled: true
            filtering_enabled: true
            dnssec_enabled: true
            cache_size: 4096
            cache_optimistic: true
            ratelimit: 20

            upstream_dns:
              - "https://dns.cloudflare.com/dns-query"
              - "tls://dns.quad9.net"

            bootstrap_dns:
              - "1.1.1.1"
              - "9.9.9.10"

          querylog:
            enabled: false
            file_enabled: false
            interval: 24h
            size_memory: 0

          statistics:
            enabled: false
            interval: 24h

          filters:
            - enabled: true
              url: https://big.oisd.nl/
              name: OISD Big
            - enabled: true
              url: https://adaway.org/hosts.txt
              name: AdAway
      notify: Restart AdGuard

    # --- FORENSE (TMPFS) ---

    - name: Forçar desmontagem do data (para aplicar permissões)
      mount:
        path: "{{ install_dir }}/data"
        state: unmounted

    - name: Garantir diretório data
      file:
        path: "{{ install_dir }}/data"
        state: directory
        mode: '0700'
        owner: root
        group: root

    - name: Mount tmpfs
      mount:
        path: "{{ install_dir }}/data"
        src: tmpfs
        fstype: tmpfs
        opts: "size=128M,mode=0700"
        state: mounted

    # --- SYSTEMD ---
    - name: Criar Unit File
      copy:
        dest: /etc/systemd/system/AdGuardHome.service
        content: |
          [Unit]
          Description=AdGuard Home
          After=network-online.target
          RequiresMountsFor={{ install_dir }}/data

          [Service]
          Type=simple
          # Caminho validado: /opt/AdGuardHome/AdGuardHome
          ExecStart={{ install_dir }}/AdGuardHome --no-check-update -c {{ install_dir }}/AdGuardHome.yaml

          StandardOutput=null
          StandardError=null
          Restart=always
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
      notify: Reload Systemd and Restart

  handlers:
    - name: Reload NetworkManager
      service:
        name: NetworkManager
        state: reloaded

    - name: Restart AdGuard
      service:
        name: AdGuardHome
        state: restarted

    - name: Reload Systemd and Restart
      systemd:
        daemon_reload: true
        name: AdGuardHome
        state: restarted
        enabled: true
