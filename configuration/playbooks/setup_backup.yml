---
- name: Configurar Backup Automático com Restic (Auditado)
  hosts: all
  become: yes
  vars:
    vault_snap_dir: "/opt/vault/snapshots"

  tasks:
    # --- 1. INSTALAÇÃO ---
    - name: Instalar Restic (Debian)
      apt:
        name: restic
        state: present
      when: ansible_os_family == "Debian"

    - name: Instalar Restic (Alpine)
      apk:
        name: restic
        state: present
      when: ansible_os_family == "Alpine"

    # --- 2. DIRETÓRIOS (Vault) ---
    - name: Criar diretório de snapshots locais
      file:
        path: "{{ vault_snap_dir }}"
        state: directory
        mode: '0700'
        owner: root
      when: "'vault' in group_names"

    # --- 3. SCRIPTS DE BACKUP ---

    # DOCKERHOST
    - name: Script Backup DockerHost
      copy:
        dest: "/usr/local/bin/backup-daily.sh"
        mode: '0700'
        content: |
          #!/bin/bash
          source /etc/restic-env.sh
          echo "--> [DockerHost] Backup iniciado..."
          
          # Backup de serviços e autenticação
          restic backup /opt/services /opt/auth \
            --exclude="*.log" \
            --exclude="*.sqlite3-wal" \
            --tag "dockerhost"
          
          restic forget --keep-daily 7 --keep-weekly 4 --keep-monthly 6 --prune
      when: "'dockerhost' in group_names"

    # VAULT (Snapshot Versionado + Auto-Renovação)
    - name: Script Backup Vault
      copy:
        dest: "/usr/local/bin/backup-daily.sh"
        mode: '0700'
        content: |
          #!/bin/bash
          source /etc/restic-env.sh
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          SNAP_FILE="{{ vault_snap_dir }}/raft-${TIMESTAMP}.snap"
          
          export VAULT_ADDR='http://127.0.0.1:8200'
          
          echo "--> [Vault] Renovando Token..."
          # Renova o token por mais 30 dias
          if ! vault token renew > /dev/null 2>&1; then
             echo "ERRO CRÍTICO: Não foi possível renovar o token do Vault. Verifique se ele expirou."
             exit 1
          fi

          echo "--> [Vault] Gerando Snapshot Raft..."
          vault operator raft snapshot save "$SNAP_FILE"
          
          if [ $? -eq 0 ]; then
            echo "--> [Vault] Enviando para B2..."
            # Backup do Snapshot + Configs (TLS, HCL)
            restic backup "$SNAP_FILE" /opt/vault/tls /etc/vault.d \
              --tag "vault"
            
            restic forget --keep-daily 7 --keep-weekly 4 --keep-monthly 6 --prune
            
            # Limpeza local de snapshots antigos (>7 dias)
            find {{ vault_snap_dir }} -type f -name "*.snap" -mtime +7 -delete
          else
            echo "ERRO CRÍTICO: Snapshot do Vault falhou!"
            exit 1
          fi
      when: "'vault' in group_names"

    # ADGUARD
    - name: Script Backup AdGuard
      copy:
        dest: "/usr/local/bin/backup-daily.sh"
        mode: '0700'
        content: |
          #!/bin/sh
          . /etc/restic-env.sh
          echo "--> [AdGuard] Backup iniciado..."
          
          restic backup /opt/AdGuardHome \
            --exclude="*.log" \
            --tag "adguard"
          
          restic forget --keep-daily 7 --keep-weekly 4 --keep-monthly 6 --prune
      when: "'adguard' in group_names"

    # MANAGEMENT
    - name: Script Backup Management
      copy:
        dest: "/usr/local/bin/backup-daily.sh"
        mode: '0700'
        content: |
          #!/bin/sh
          . /etc/restic-env.sh
          echo "--> [Management] Backup iniciado..."
          
          # Backup do repositório Git central e chaves SSH
          restic backup /opt/homelab /root/.ssh \
            --exclude=".git" \
            --tag "management"
          
          restic forget --keep-daily 7 --keep-weekly 4 --keep-monthly 6 --prune
      when: "'management' in group_names"

    # --- 4. AGENDAMENTO ---
    # Correção: Lógica inline para evitar erro de indentação YAML
    - name: Configurar Cronjob
      cron:
        name: "Backup Diario Restic"
        minute: "{{ cron_min }}"
        hour: "4"
        job: "/usr/local/bin/backup-daily.sh >> /var/log/backup-restic.log 2>&1"
      vars:
        cron_min: "{{ '00' if 'dockerhost' in group_names else '15' if 'vault' in group_names else '30' if 'adguard' in group_names else '45' }}"
