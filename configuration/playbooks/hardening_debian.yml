---
- name: Hardening Completo do Debian (DockerHost & Vault)
  hosts: debian
  become: yes

  tasks:
    # --- ATUALIZAÇÕES E PACOTES ---
    - name: Atualizar cache e sistema (Safe Upgrade)
      apt:
        update_cache: yes
        upgrade: safe # Alterado de 'dist' para 'safe' para evitar quebra de dependências críticas
        cache_valid_time: 3600

    - name: Instalar ferramentas essenciais de administração
      apt:
        name:
          - curl
          - wget
          - git
          - rsync
          - htop
          - ncdu       # Analisador de disco (Útil para logs cheios)
          - fastfetch  # Tem que ter :D
          - sudo
          - vim
          - fail2ban   # Proteção contra brute-force
          - unattended-upgrades # Patch de segurança automático
          - apt-listchanges
        state: present

    # --- TIMEZONE ---
    - name: Configurar Timezone para America/Sao_Paulo
      timezone:
        name: America/Sao_Paulo

    # --- CONFIGURAÇÃO SSH ---
    - name: Hardening SSH - Desativar Login Root
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin prohibit-password'
        state: present
      notify: Restart SSH

    - name: Hardening SSH - Desativar Autenticação por Senha
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication no'
        state: present
      notify: Restart SSH

    - name: Hardening SSH - Forçar Pubkey
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PubkeyAuthentication'
        line: 'PubkeyAuthentication yes'
        state: present
      notify: Restart SSH

    # Parâmetro Moderno (Debian 12/13) - Substitui ChallengeResponse
    - name: Hardening SSH - Desativar KbdInteractiveAuthentication
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?KbdInteractiveAuthentication'
        line: 'KbdInteractiveAuthentication no'
        state: present
      notify: Restart SSH

    # Mantido para compatibilidade com versões antigas, se houver
    - name: Hardening SSH - Desativar ChallengeResponse (Legacy)
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?ChallengeResponseAuthentication'
        line: 'ChallengeResponseAuthentication no'
        state: present
      notify: Restart SSH

    # --- CONFIGURAÇÃO FAIL2BAN ---
    - name: Configurar Fail2Ban (jail.local)
      copy:
        dest: /etc/fail2ban/jail.local
        content: |
          [DEFAULT]
          # Banir por 1 hora (3600s)
          bantime = 1h
          # Janela de tempo para contar falhas (10 min)
          findtime = 10m
          # Máximo de tentativas antes do ban
          maxretry = 3
          # Usar Systemd (Obrigatório para Debian 12+)
          backend = systemd
          # Whitelist: Localhost + Management + Rede Trusted
          # Trade-off: Whitelist da rede evita lockout acidental no homelab
          ignoreip = 127.0.0.1/8 10.10.10.10 10.10.20.0/24

          [sshd]
          enabled = true
          mode    = aggressive
          port    = ssh
        mode: '0644'
      notify: Restart Fail2Ban

    # --- SERVIÇOS DE SEGURANÇA ---
    - name: Garantir que Fail2Ban esteja rodando
      service:
        name: fail2ban
        state: started
        enabled: yes

    - name: Configurar Unattended Upgrades (Ativar atualizações de segurança)
      copy:
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        content: |
          APT::Periodic::Update-Package-Lists "1";
          APT::Periodic::Unattended-Upgrade "1";

    # --- DOCKER CONFIG (CRÍTICO PARA O ALLOY) ---     
    - name: Garantir Log Driver json-file no Docker
      copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "3"
            }
          }
        owner: root
        group: root
        mode: '0644'
      when: "'dockerhost' in group_names" # Só faz no DockerHost, Vault não tem docker
      notify: Restart Docker

    # --- FIREWALL (VAULT ONLY) ---
    - name: Liberar métricas (9100) para o DockerHost no Vault
      ufw:
        rule: allow
        port: '9100'
        proto: tcp
        from_ip: 10.10.30.10  # IP do DockerHost (Onde roda o Prometheus)
        comment: "Allow Prometheus Scrape"
      when: "'vault' in group_names"  # CRÍTICO: Não rodar no DockerHost (que não usa UFW)

    # --- MONITORAMENTO NATIVO ---
    - name: Instalar Node Exporter (Sistema)
      apt:
        name: prometheus-node-exporter
        state: present
        update_cache: yes

  handlers:
    - name: Restart SSH
      service:
        name: ssh
        state: restarted

    - name: Restart Fail2Ban
      service:
        name: fail2ban
        state: restarted

    - name: Restart Docker
      service:
        name: docker
        state: restarted
