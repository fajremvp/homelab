---
- name: Setup de Armazenamento Adicional (Mídia)
  hosts: dockerhost
  become: yes

  vars:
    # ATUALIZADO: Aponta para sdb (realidade atual) para segurança
    target_disk: "/dev/sdb"
    mount_point: "/mnt/media"
    owner_user: "fajre"
    owner_group: "docker"

  tasks:
    - name: Garantir ferramentas de sistema de arquivos (ext4)
      apt:
        name: e2fsprogs
        state: present

    # Esta tarefa será "skipped" ou "ok" porque o disco já tem o label media_disk
    - name: Criar sistema de arquivos ext4 no disco inteiro
      community.general.filesystem:
        fstype: ext4
        dev: "{{ target_disk }}"
        opts: "-m 0 -L media_disk"

    - name: Criar diretório de montagem
      file:
        path: "{{ mount_point }}"
        state: directory
        mode: '0755'

    - name: Montar disco (e persistir no fstab)
      mount:
        path: "{{ mount_point }}"
        # MUDANÇA: Usar o LABEL em vez do dispositivo (/dev/sdb)
        # Isso garante que o boot funcione mesmo se o disco mudar de nome
        src: "LABEL=media_disk"
        fstype: ext4
        opts: defaults,noatime
        state: mounted

    - name: Ajustar permissões para Docker
      file:
        path: "{{ mount_point }}"
        state: directory
        owner: "{{ owner_user }}"
        group: "{{ owner_group }}"
        mode: '0775'
        recurse: yes
